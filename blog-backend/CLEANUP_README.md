# 数据清理机制说明

## 密码重置令牌清理

### 工作原理

1. **过期时间设置**
   - 密码重置验证码的有效期为 **15分钟**
   - 过期时间存储在 `password_reset_tokens` 表的 `expire_at` 字段

2. **验证机制**
   - 用户使用验证码重置密码时，系统会检查 `expire_at` 字段
   - 如果当前时间超过 `expire_at`，验证码将被拒绝
   - 查询条件：`WHERE expire_at > NOW() AND is_used = false`

3. **自动清理**
   - 后端启动时会自动开启定期清理任务
   - 清理频率：**每小时一次**
   - 清理内容：删除所有 `expire_at < NOW()` 的记录
   - 日志输出：每次清理完成后会打印时间戳

### 数据清理时间线

```
用户请求验证码
    ↓
创建记录 (expire_at = now + 15分钟)
    ↓
15分钟内有效 ✓
    ↓
15分钟后过期 ✗ (但记录仍保留在数据库)
    ↓
下一次定时清理任务执行时删除 (最多1小时后)
```

### 示例

假设当前时间是 `2025-10-28 16:00:00`：

1. **16:00:00** - 用户请求验证码
   - 创建记录，`expire_at = 2025-10-28 16:15:00`

2. **16:15:00** - 验证码过期
   - 此时验证码不能再使用（验证会失败）
   - 但数据库记录依然存在

3. **17:00:00** - 定时清理任务执行
   - 删除所有 `expire_at < 2025-10-28 17:00:00` 的记录
   - 包括上面创建的已过期记录

### 手动清理

如果需要立即清理过期数据，可以执行以下 SQL：

```sql
DELETE FROM password_reset_tokens WHERE expire_at < NOW();
```

### 配置修改

如果需要修改清理频率，编辑 `service/cleanup.go`：

```go
// 修改这个时间间隔
go s.cleanupExpiredTokensPeriodically(1 * time.Hour)  // 当前为1小时
```

可选值：
- `30 * time.Minute` - 30分钟
- `2 * time.Hour` - 2小时
- `24 * time.Hour` - 24小时

### 监控

启动后端时，会看到以下日志：

```
[INFO] Cleanup tasks started
[INFO] 过期令牌清理完成: 2025-10-28 17:00:00
[INFO] 过期令牌清理完成: 2025-10-28 18:00:00
...
```

如果清理失败，会显示错误：
```
[ERROR] 清理过期令牌失败: <错误详情>
```

